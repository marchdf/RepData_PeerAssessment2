---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---
# Synopsis


# Data Processing

## Load some libraries
```{r}
library(stringr)
library(dplyr)
library(lubridate)
library(ggplot2)
```

## Download the data

Download the data and extract it only if it has not been done yet.

Setup some directory, file, and url names 
```{r}
datadir <- "./data"
tarname <- paste(datadir,"/stormdata.csv.bz2",sep='')
furl    <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
```

Create data directory and download the tar file and load the data (if
it hasn't been done already)
```{r}
dir.create(datadir, showWarnings = FALSE)

## Download data if necessary
if (!file.exists(tarname)) {
    download.file(furl,tarname)
}

## Load the data if it hasn't been loaded yet
if(!exists("dataf")) {
    dataf <- read.csv(tarname)
}
```

## Format the data

Let's only keep the columns that will be usefull
```{r}
keep <- c("BGN_DATE","BGN_TIME","EVTYPE","FATALITIES","INJURIES","PROPDMG","PROPDMGEXP","CROPDMG","CROPDMGEXP")
df <- dataf[keep]
```

Let's remove all the data which has no fatalities, injuries, property
damage, and crop damage.
```{r}
df <- df %>%
    filter(FATALITIES > 0 | INJURIES > 0 | PROPDMG > 0 | CROPDMG > 0) %>%
    droplevels()
dfrows <- nrow(df)
```
We just removed `r 100*(1-dfrows/nrow(dataf))`% of the data (events
which had no health or economic damage).

Now, let's remove the data which doesn't have a valid exponent and add
columns corresponding to the numeric value of the letter symbol
exponent (H=100, K=1000, M=1000000, B=1000000000). We create two new
columns where we combine the values and exponents of the crop and
property damage.
```{r}
## Make it the exponent letters uppercase (for consistency)
df <- df %>%
    mutate_each( funs(toupper),PROPDMGEXP,CROPDMGEXP) %>%
    mutate_each( funs(as.character),PROPDMGEXP,CROPDMGEXP) %>%
    droplevels()

## This lookup table makes the correspondance between letters and numbers
lookup_exp <- data.frame(c("","H","K","M","B"),
                         numeric.value=c(1,100,1000,1000000,1000000000))

## Change the column names and join with the two for the crops
colnames(lookup_exp) <- c("CROPDMGEXP", "CROPEXPVALUE")
df <- left_join(df,lookup_exp)

## Change the column names and join with the two for the property
colnames(lookup_exp) <- c("PROPDMGEXP", "PROPEXPVALUE")
df <- left_join(df,lookup_exp)

## Change the name again just to make things clean
colnames(lookup_exp) <- c("valid_exp", "numeric.value")

## Now create new columns which contain the full numeric value of the
## damage done (P/CROPDMG*P/CROPEXPVALUE)
df <- df %>%
    mutate(NUMERIC.PROPDMG = PROPDMG*PROPEXPVALUE,
           NUMERIC.CROPDMG = CROPDMG*CROPEXPVALUE)
```


Format the event types and drop those that look like mistakes
- drop the "?" event type
- drop the "apache county" event type
- replace "tstm" with "thunderstorm"
```{r}
tmp <- df %>%
    mutate(EVTYPE = as.factor(tolower(df$EVTYPE))) %>%
    filter(!grepl('\\?|apache county', EVTYPE)) %>%
    mutate(EVTYPE=as.factor(str_replace(EVTYPE, "tstm", "thunderstorm"))) %>%
    droplevels()

tmp <- tmp %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*torn.*", "tornado")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thunderstorm.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thuderstorm winds.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thundeerstorm winds.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thunderestorm winds.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thunderstrom wind.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thundertorm winds.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*thunerstorm winds.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*tunderstorm wind.*", "thunderstorm wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flooding.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*river flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*river flooding.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*breakup flooding.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flood & heavy rain.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flooding/heavy rain.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flood/rain/winds.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flood/river flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*floods.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*major flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*minor flooding.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*river and stream flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*rural flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*small stream flood.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*snowmelt flooding.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*urban.*", "flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*lake flood.*", "lakeshore flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*flash.*", "flash flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*coastal flooding.*", "coastal flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*coastal  flooding/erosion.*", "coastal flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*tidal flooding.*", "coastal flood")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*heat.*", "heat")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*lightning.*", "lightning")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*ice.*", "ice")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*hail.*", "hail")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*hurricane.*", "hurricane/typhoon")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*typhoon.*", "hurricane/typhoon")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*winter storm.*", "winter storm")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*rip.*", "rip current")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*avala.*", "avalanche")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*blizzard.*", "blizzard")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*tropical.*", "tropical strom")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*wild.*", "wildfire")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*surge.*", "storm tide")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*land.*", "land slide")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*heavy rain.*", "heavy rain")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*strong wind.*", "strong wind")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*extreme.*", "extreme cold/wind chill")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*frost.*", "frost/freeze")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*freeze.*", "frost/freeze")) %>%
    mutate(EVTYPE=str_replace(EVTYPE, ".*high wind.*", "high wind")) %>%
    group_by(EVTYPE) %>%
    ## summarize(num = sum(INJURIES)) %>%
    ## summarize(num = sum(FATALITIES)) %>%
    summarize(num = sum(NUMERIC.PROPDMG)) %>%
    ## summarize(num = sum(NUMERIC.CROPDMG)) %>%
    mutate(percent = num/(sum(num,na.rm=TRUE))*100)


write.csv(tmp[order(tmp$num, decreasing= T),],"c.csv")

##evtypes <- levels(tmp$EVTYPE)



## types <- c("Astronomical Tide","Avalanche","Blizzard","Coastal Flood","Cold/Wind Chill","Debris Flow","Dense Fog ","Dense Smoke","Drought","Dust Devil","Dust Storm","Extreme Cold/Wind Chill","Flash Flood","Flood","Freezing Fog","Frost/Freeze","Funnel Cloud","Hail","Heat","Heavy Rain","Heavy Snow","High Surf","High Wind","Hurricane/Typhoon","Ice","Lakeshore Flood","Lake-Effect Snow","Lightning","Hail","Marine Thunderstorm Wind","Rip Current","Seiche","Sleet","Storm Tide","Strong Wind","Thunderstorm Wind","Tornado","Tropical Depression","Tropical Storm","Tsunami","Volcanic Ash","Waterspout","Wildfire","Winter Storm","Winter Weather","Land Slide")

## d <- adist(evtypes, types, ignore.case=TRUE)
## rownames(d) <- evtypes
## colnames(d) <- types
## result <- data.frame(t(sapply(seq(nrow(d)), function(i) { j <- which.min(d[i,]); c(rownames(d)[i], colnames(d)[j], as.numeric(d[i,j]))})))
## colnames(result) <- c("EVTYPE","guess.type","score")
## result$score <- as.numeric(result$score)
## result %>% group_by(score) %>% summarize(no_rows = length(score))

## tmp <- df %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "severe thunderstorm", "thunderstorm wind")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "snowmelt flooding", "flood")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "urban and small", "flood")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "falling snow/ice", "heavy snow")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
##     mutate(EVTYPE=str_replace(EVTYPE, "", "")) %>%
    
##     droplevels()



```





```{r}
## sumdf <- dataf %>%
##     group_by(CROPDMGEXP) %>%
##     summarize(no_rows=length(CROPDMGEXP)) %>%
##     filter(CROPDMGEXP %in% valid_exp)
## sumdf <- dataf %>%
##     group_by(PROPDMGEXP) %>%
##     summarize(no_rows=length(PROPDMGEXP)) %>%
##     filter(PROPDMGEXP %in% valid)
```
We just dropped `r 1-sum(sumdf$no_row)/nrow(dataf)`% of the data.

# Results
